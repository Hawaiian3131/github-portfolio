"""
Malware & Threat Detection Module
Hash verification, suspicious pattern detection, Windows Defender integration
"""
import hashlib
import subprocess
from pathlib import Path
from typing import Dict, List, Tuple, Set
import json
import re


class MalwareScanner:
    def __init__(self):
        """Initialize malware scanner"""
        self.quarantine_folder = Path("_Quarantine")
        self.quarantine_folder.mkdir(exist_ok=True)
        
        # Known malware hashes (example - update with real threat intelligence)
        self.malware_hashes = self.load_malware_database()
        
        # Suspicious file extensions
        self.suspicious_extensions = {
            '.exe', '.bat', '.cmd', '.com', '.pif', '.scr',
            '.vbs', '.js', '.jar', '.msi', '.dll', '.sys'
        }
        
        # Suspicious filename patterns
        self.suspicious_patterns = [
            r'.*ransomware.*',
            r'.*trojan.*',
            r'.*virus.*',
            r'.*malware.*',
            r'.*hack.*',
            r'.*crack.*',
            r'.*keygen.*'
        ]
    
    def load_malware_database(self) -> Set[str]:
        """Load known malware hashes"""
        db_file = Path("malware_hashes.json")
        if db_file.exists():
            with open(db_file, 'r') as f:
                return set(json.load(f))
        return set()
    
    def calculate_file_hash(self, file_path: Path) -> str:
        """Calculate SHA-256 hash of file"""
        sha256 = hashlib.sha256()
        try:
            with open(file_path, 'rb') as f:
                for chunk in iter(lambda: f.read(4096), b""):
                    sha256.update(chunk)
            return sha256.hexdigest()
        except:
            return None
    
    def scan_file(self, file_path: Path) -> Dict:
        """
        Scan single file for threats
        
        Returns:
            Scan results dictionary
        """
        results = {
            "file": str(file_path),
            "threat_level": "SAFE",
            "threats_found": [],
            "hash": None,
            "action_taken": None
        }
        
        # Calculate hash
        file_hash = self.calculate_file_hash(file_path)
        results["hash"] = file_hash
        
        # Check against malware database
        if file_hash and file_hash in self.malware_hashes:
            results["threat_level"] = "CRITICAL"
            results["threats_found"].append("KNOWN_MALWARE_HASH")
        
        # Check suspicious extension
        if file_path.suffix.lower() in self.suspicious_extensions:
            if results["threat_level"] == "SAFE":
                results["threat_level"] = "SUSPICIOUS"
            results["threats_found"].append("SUSPICIOUS_EXTENSION")
        
        # Check filename patterns
        for pattern in self.suspicious_patterns:
            if re.match(pattern, file_path.name.lower()):
                if results["threat_level"] == "SAFE":
                    results["threat_level"] = "SUSPICIOUS"
                results["threats_found"].append(f"SUSPICIOUS_PATTERN: {pattern}")
        
        # Check file size anomalies
        try:
            size_mb = file_path.stat().st_size / (1024 * 1024)
            if size_mb > 500 and file_path.suffix in ['.txt', '.doc']:
                results["threats_found"].append("SIZE_ANOMALY")
        except:
            pass
        
        return results
    
    def scan_with_defender(self, file_path: Path) -> Tuple[bool, str]:
        """
        Scan file using Windows Defender
        
        Returns:
            (is_safe, message)
        """
        try:
            # Run Windows Defender scan
            cmd = [
                "C:\\Program Files\\Windows Defender\\MpCmdRun.exe",
                "-Scan",
                "-ScanType", "3",
                "-File", str(file_path)
            ]
            
            result = subprocess.run(cmd, capture_output=True, text=True, timeout=60)
            
            if result.returncode == 0:
                return True, "No threats detected"
            else:
                return False, "Threat detected by Windows Defender"
        
        except FileNotFoundError:
            return True, "Windows Defender not available"
        except subprocess.TimeoutExpired:
            return False, "Scan timeout"
        except Exception as e:
            return True, f"Scan error: {str(e)}"
    
    def quarantine_file(self, file_path: Path) -> Tuple[bool, str]:
        """
        Move file to quarantine
        
        Returns:
            (success, message)
        """
        try:
            quarantine_path = self.quarantine_folder / file_path.name
            file_path.rename(quarantine_path)
            
            # Log quarantine event
            self.log_quarantine(file_path, quarantine_path)
            
            return True, f"File quarantined: {quarantine_path}"
        except Exception as e:
            return False, f"Quarantine failed: {str(e)}"
    
    def log_quarantine(self, original_path: Path, quarantine_path: Path):
        """Log quarantine action"""
        log_file = self.quarantine_folder / "quarantine_log.json"
        
        entry = {
            "timestamp": str(Path(__file__).stat().st_ctime),
            "original_path": str(original_path),
            "quarantine_path": str(quarantine_path)
        }
        
        try:
            if log_file.exists():
                with open(log_file, 'r') as f:
                    log = json.load(f)
            else:
                log = []
            
            log.append(entry)
            
            with open(log_file, 'w') as f:
                json.dump(log, f, indent=4)
        except:
            pass
    
    def scan_batch(self, file_paths: List[Path]) -> Dict:
        """
        Scan multiple files
        
        Returns:
            Summary of scan results
        """
        summary = {
            "total_scanned": 0,
            "safe": 0,
            "suspicious": 0,
            "critical": 0,
            "quarantined": 0,
            "details": []
        }
        
        for file_path in file_paths:
            if not file_path.is_file():
                continue
            
            results = self.scan_file(file_path)
            summary["total_scanned"] += 1
            
            if results["threat_level"] == "SAFE":
                summary["safe"] += 1
            elif results["threat_level"] == "SUSPICIOUS":
                summary["suspicious"] += 1
            elif results["threat_level"] == "CRITICAL":
                summary["critical"] += 1
                # Auto-quarantine critical threats
                success, msg = self.quarantine_file(file_path)
                if success:
                    summary["quarantined"] += 1
                    results["action_taken"] = "QUARANTINED"
            
            summary["details"].append(results)
        
        return summary
    
    def update_malware_database(self, hashes: List[str]):
        """Add new malware hashes to database"""
        self.malware_hashes.update(hashes)
        
        db_file = Path("malware_hashes.json")
        with open(db_file, 'w') as f:
            json.dump(list(self.malware_hashes), f, indent=4)


# Threat intelligence sources (examples)
THREAT_INTEL_SOURCES = {
    "virustotal": "https://www.virustotal.com/api/v3/",
    "malwarebazaar": "https://bazaar.abuse.ch/api/",
    "urlhaus": "https://urlhaus-api.abuse.ch/v1/"
}
